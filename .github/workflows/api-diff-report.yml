name: API Diff Report

on:
  pull_request:
    paths:
      - "packages/api-client/openapi-spec.yaml"

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      # 1. Head ë¸Œëœì¹˜(PR ë¸Œëœì¹˜)ì˜ ì½”ë“œë¥¼ checkout
      - name: Checkout Head Branch
        uses: actions/checkout@v4

      # 2. Base ë¸Œëœì¹˜(e.g., main)ì˜ ì½”ë“œë¥¼ ë³„ë„ ë””ë ‰í† ë¦¬ì— checkout
      - name: Checkout Base Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      # 3. oasdiff ì„¤ì¹˜
      - name: Install oasdiff
        run: go install github.com/tufin/oasdiff@latest

      # 4. oasdiff ì‹¤í–‰í•˜ì—¬ ë³€ê²½ì  ì¶”ì¶œ (Markdown í¬ë§·)
      - name: Run oasdiff
        id: diff
        run: |
          OAS_BASE_PATH="base/packages/api-client/openapi-spec.yaml"
          OAS_HEAD_PATH="packages/api-client/openapi-spec.yaml"

          # Base íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° (ìƒˆë¡œìš´ íŒŒì¼)
          if [ ! -f "$OAS_BASE_PATH" ]; then
            echo "diff_markdown<<EOF" >> $GITHUB_OUTPUT
            echo "## ğŸ†• ìƒˆë¡œìš´ OpenAPI ìŠ¤í™ íŒŒì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            # oasdiff ì‹¤í–‰
            DIFF_OUTPUT=$(oasdiff -base "$OAS_BASE_PATH" -revision "$OAS_HEAD_PATH" -format markdown 2>/dev/null || echo "ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            echo "diff_markdown<<EOF" >> $GITHUB_OUTPUT
            echo "$DIFF_OUTPUT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      # 5. ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì²˜ë¦¬
      - name: Process API Changes
        id: analysis
        run: |
          DIFF_CONTENT="${{ steps.diff.outputs.diff_markdown }}"

          # ë³€ê²½ì‚¬í•­ì´ ë¹„ì–´ìˆê±°ë‚˜ "No changes" í¬í•¨ ì‹œ ìŠ¤í‚µ
          if [ -z "$DIFF_CONTENT" ] || [[ "$DIFF_CONTENT" == *"No changes"* ]]; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "has_changes=false" >> $GITHUB_OUTPUT  
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # PR ì½”ë©˜íŠ¸ ìƒì„±
          PR_COMMENT=$(cat <<'EOL'
          ## ğŸ“Š API ë³€ê²½ì‚¬í•­ ìš”ì•½

          ### ğŸ”— ê´€ë ¨ PR
          - **PR**: #${{ github.event.pull_request.number }}
          - **ë¸Œëœì¹˜**: `${{ github.head_ref }}` â†’ `${{ github.base_ref }}`
          - **ì‘ì„±ì**: @${{ github.event.pull_request.user.login }}

          ### ğŸ“‹ ë³€ê²½ ë‚´ìš©
          $DIFF_CONTENT

          ---
          *ğŸ¤– ìë™ ìƒì„±ëœ API ë³€ê²½ ë¦¬í¬íŠ¸*
          EOL
          )

          # Slack ë©”ì‹œì§€ ìƒì„±  
          SLACK_MESSAGE=$(cat <<'EOL'
          ğŸš€ *API ë³€ê²½ì‚¬í•­ ê°ì§€*

          *PR*: <${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }}>
          *ë¸Œëœì¹˜*: `${{ github.head_ref }}` â†’ `${{ github.base_ref }}`
          *ì‘ì„±ì*: ${{ github.event.pull_request.user.login }}

          ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”! ğŸ‘†
          EOL
          )

          # ì¶œë ¥ ì„¤ì •
          echo "pr_comment<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "slack_message<<EOF" >> $GITHUB_OUTPUT
          echo "$SLACK_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 6. GitHub PRì— ë¶„ì„ ê²°ê³¼ ì½”ë©˜íŠ¸ ì‘ì„± (ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
      - name: Create or Update PR Comment
        if: steps.analysis.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.analysis.outputs.pr_comment }}

      # 7. Slack ì±„ë„ë¡œ ì•Œë¦¼ ì „ì†¡ (ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
      - name: Send Slack Notification
        if: steps.analysis.outputs.has_changes == 'true'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "${{ steps.analysis.outputs.slack_message }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ“ *API ë³€ê²½ì‚¬í•­ ì•Œë¦¼*\n\n<${{ github.event.pull_request.html_url }}|PR #${{ github.event.pull_request.number }}>ì—ì„œ OpenAPI ëª…ì„¸ ë³€ê²½ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n*ë¸Œëœì¹˜*: `${{ github.head_ref }}` â†’ `${{ github.base_ref }}`\n*ì‘ì„±ì*: ${{ github.event.pull_request.user.login }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "PR í™•ì¸í•˜ê¸°"
                      },
                      "url": "${{ github.event.pull_request.html_url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_API_CHANGE_LOGS_CHANNEL_WEBHOOK_URL }}
