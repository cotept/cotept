name: API Diff Report

on:
  pull_request:
    paths:
      - "packages/api-client/openapi-spec.yaml"

jobs:
  report:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      # 1. Head ë¸Œëœì¹˜(PR ë¸Œëœì¹˜)ì˜ ì½”ë“œë¥¼ checkout
      - name: Checkout Head Branch
        uses: actions/checkout@v4

      # 2. Base ë¸Œëœì¹˜(e.g., main)ì˜ ì½”ë“œë¥¼ ë³„ë„ ë””ë ‰í† ë¦¬ì— checkout
      - name: Checkout Base Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      # 3. oasdiff ì„¤ì¹˜
      - name: Install oasdiff
        run: go install github.com/oasdiff/oasdiff@latest

      # 4. oasdiff ì‹¤í–‰í•˜ì—¬ ë³€ê²½ì  ì¶”ì¶œ (Markdown í¬ë§·)
      - name: Run oasdiff
        id: diff
        run: |
          OAS_BASE_PATH="base/packages/api-client/openapi-spec.yaml"
          OAS_HEAD_PATH="packages/api-client/openapi-spec.yaml"

          # Base íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° (ìƒˆë¡œìš´ íŒŒì¼)
          if [ ! -f "$OAS_BASE_PATH" ]; then
            echo "diff_markdown<<EOF" >> $GITHUB_OUTPUT
            echo "## ğŸ†• ìƒˆë¡œìš´ OpenAPI ìŠ¤í™ íŒŒì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            # oasdiff ì‹¤í–‰
            DIFF_OUTPUT=$(oasdiff -base "$OAS_BASE_PATH" -revision "$OAS_HEAD_PATH" -format markdown 2>/dev/null || echo "ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            echo "diff_markdown<<EOF" >> $GITHUB_OUTPUT
            echo "$DIFF_OUTPUT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      # 5. ë©”íƒ€ë°ì´í„° ìˆ˜ì§‘
      - name: Collect Metadata
        id: metadata
        run: |
          # API ë²„ì „ ì¶”ì¶œ (openapi-spec.yamlì—ì„œ)
          if [ -f "packages/api-client/openapi-spec.yaml" ]; then
            # info ì„¹ì…˜ ì•„ë˜ì˜ version ì¶”ì¶œ (ì•ì— ê³µë°± 2ê°œ ìˆìŒ)
            API_VERSION=$(grep -E "^  version:" packages/api-client/openapi-spec.yaml | awk '{print $2}' | tr -d '"' | tr -d "'" || echo "unknown")
            # info ì„¹ì…˜ ì•„ë˜ì˜ title ì¶”ì¶œ (ì•ì— ê³µë°± 2ê°œ ìˆìŒ)  
            API_TITLE=$(grep -E "^  title:" packages/api-client/openapi-spec.yaml | awk -F': ' '{print $2}' | sed 's/^ *//' | tr -d '"' | tr -d "'" || echo "CotePT API")
          else
            API_VERSION="unknown"
            API_TITLE="CotePT API"
          fi
          
          # ì‹œê°„ ì •ë³´ (KST)
          CURRENT_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')
          
          # ì»¤ë°‹ ì •ë³´
          SHORT_SHA=${GITHUB_SHA:0:7}
          
          # ì›Œí¬í”Œë¡œìš° ì‹œì‘ ì‹œê°„
          WORKFLOW_START_TIME=$(date +%s)
          
          # ê²°ê³¼ ì¶œë ¥ (ë©€í‹°ë¼ì¸ ë°©ì‹ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
          {
            echo "api_version<<EOF"
            echo "$API_VERSION"
            echo "EOF"
            echo "api_title<<EOF"
            echo "$API_TITLE"
            echo "EOF"
            echo "current_time<<EOF"
            echo "$CURRENT_TIME"
            echo "EOF"
            echo "short_sha<<EOF"
            echo "$SHORT_SHA"
            echo "EOF"
            echo "workflow_start_time<<EOF"
            echo "$WORKFLOW_START_TIME"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # 6. ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì²˜ë¦¬
      - name: Process API Changes
        id: analysis
        run: |
          DIFF_CONTENT="${{ steps.diff.outputs.diff_markdown }}"

          # ë³€ê²½ì‚¬í•­ì´ ë¹„ì–´ìˆê±°ë‚˜ "No changes" í¬í•¨ ì‹œ ìŠ¤í‚µ
          if [ -z "$DIFF_CONTENT" ] || [[ "$DIFF_CONTENT" == *"No changes"* ]]; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "has_changes=false" >> $GITHUB_OUTPUT  
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # PR ì½”ë©˜íŠ¸ ìƒì„±
          PR_COMMENT=$(cat <<'EOL'
          ## ğŸ“Š API ë³€ê²½ì‚¬í•­ ìš”ì•½

          ### ğŸ”— ê´€ë ¨ PR
          - **PR**: #${{ github.event.pull_request.number }}
          - **ë¸Œëœì¹˜**: `${{ github.head_ref }}` â†’ `${{ github.base_ref }}`
          - **ì‘ì„±ì**: @${{ github.event.pull_request.user.login }}

          ### ğŸ“‹ ë³€ê²½ ë‚´ìš©
          $DIFF_CONTENT

          ---
          *ğŸ¤– ìë™ ìƒì„±ëœ API ë³€ê²½ ë¦¬í¬íŠ¸*
          EOL
          )

          # Slack ë©”ì‹œì§€ ìƒì„±  
          SLACK_MESSAGE=$(cat <<'EOL'
          ğŸš€ *API ë³€ê²½ì‚¬í•­ ê°ì§€*

          *PR*: <${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }}>
          *ë¸Œëœì¹˜*: `${{ github.head_ref }}` â†’ `${{ github.base_ref }}`
          *ì‘ì„±ì*: ${{ github.event.pull_request.user.login }}

          ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”! ğŸ‘†
          EOL
          )

          # ì¶œë ¥ ì„¤ì •
          echo "pr_comment<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "slack_message<<EOF" >> $GITHUB_OUTPUT
          echo "$SLACK_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 6. GitHub PRì— ë¶„ì„ ê²°ê³¼ ì½”ë©˜íŠ¸ ì‘ì„± (ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
      - name: Create or Update PR Comment
        if: steps.analysis.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.analysis.outputs.pr_comment }}

      # 7. ì‹¤í–‰ ì‹œê°„ ê³„ì‚°
      - name: Calculate Workflow Duration
        if: steps.analysis.outputs.has_changes == 'true'
        id: timing
        run: |
          # ì‹¤í–‰ ì‹œê°„ ê³„ì‚°
          WORKFLOW_END_TIME=$(date +%s)
          WORKFLOW_DURATION=$((WORKFLOW_END_TIME - ${{ steps.metadata.outputs.workflow_start_time }}))
          
          # ê²°ê³¼ ì¶œë ¥
          {
            echo "workflow_duration<<EOF"
            echo "${WORKFLOW_DURATION}"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # 8. ì•ˆì „í•œ Slack ì•Œë¦¼ ì „ì†¡
      - name: Send Safe Slack Notification
        if: steps.analysis.outputs.has_changes == 'true'
        run: |
          # ì•ˆì „í•œ ë©”ì‹œì§€ ìƒì„±
          MESSAGE="API ë³€ê²½ì‚¬í•­ ê°ì§€: ${{ steps.metadata.outputs.api_title }} v${{ steps.metadata.outputs.api_version }}

          ë³€ê²½ ì‹œê°„: ${{ steps.metadata.outputs.current_time }}
          ì‘ì„±ì: @${{ github.event.pull_request.user.login }}
          ì»¤ë°‹: ${{ steps.metadata.outputs.short_sha }}
          ë¸Œëœì¹˜: ${{ github.head_ref }} -> ${{ github.base_ref }}

          PR: ${{ github.event.pull_request.html_url }}

          oasdiff ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. PR ì½”ë©˜íŠ¸ì—ì„œ ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”."

          # curlë¡œ ì§ì ‘ ì „ì†¡
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$MESSAGE\"}" \
            "${{ secrets.SLACK_API_CHANGE_LOGS_CHANNEL_WEBHOOK_URL }}"
