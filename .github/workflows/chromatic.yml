# Chromatic Storybook ë°°í¬ ì›Œí¬í”Œë¡œìš°
name: "Chromatic"

# PRê³¼ main ë¸Œëœì¹˜ pushì—ì„œ ì‹¤í–‰
on:
  push:
    branches:
      - main
    paths:
      - "apps/web/**"
      - "packages/shared/**"
      - ".github/workflows/chromatic.yml"
  pull_request:
    paths:
      - "apps/web/**"
      - "packages/shared/**"
      - ".github/workflows/chromatic.yml"

# ë™ì‹œ ì‹¤í–‰ ì œí•œ
concurrency:
  group: chromatic-${{ github.ref }}
  cancel-in-progress: true

jobs:
  chromatic-deployment:
    runs-on: ubuntu-latest
    name: Deploy Storybook to Chromatic

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Chromaticì´ git historyë¥¼ í•„ìš”ë¡œ í•¨ (ë³€ê²½ì‚¬í•­ ì¶”ì ìš©)
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.6

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm build --filter=@repo/shared

      - name: Build Storybook
        run: pnpm --filter=web build-storybook
        env:
          NODE_ENV: production

      - name: Publish to Chromatic
        uses: chromaui/action@latest
        with:
          # Chromatic í”„ë¡œì íŠ¸ í† í°
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          # Storybook ë¹Œë“œ ê²°ê³¼ë¬¼ ìœ„ì¹˜
          storybookBuildDir: apps/web/storybook-static
          # ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ë„ ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ
          exitZeroOnChanges: true
          # PRì—ì„œë§Œ ì‹œê°ì  ë³€ê²½ì‚¬í•­ ê°ì§€
          onlyChanged: ${{ github.event_name == 'pull_request' }}
          # ìë™ ìŠ¹ì¸ (main ë¸Œëœì¹˜ì˜ ê²½ìš°)
          autoAcceptChanges: ${{ github.ref == 'refs/heads/main' }}
          # ì—…ë¡œë“œ ì™„ë£Œ ì‹œì ì—ì„œ ë°”ë¡œ ì‘ì—…ì„ ì¢…ë£Œ
          exitOnceUploaded: true
        env:
          # GitHub í† í° (PR ì½”ë©˜íŠ¸ ì‘ì„±ìš©)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment PR with Storybook URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ“š Storybook Preview')
            );

            const storybookUrl = process.env.CHROMATIC_BUILD_URL || 'Building...';
            const body = `## ğŸ“š Storybook Preview

            âœ¨ **Storybookì´ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!**

            ğŸ”— **ë¯¸ë¦¬ë³´ê¸° ë§í¬**: ${storybookUrl}

            > ğŸ¨ ì´ PRì˜ ì»´í¬ë„ŒíŠ¸ ë³€ê²½ì‚¬í•­ì„ Storybookì—ì„œ í™•ì¸í•´ë³´ì„¸ìš”.
            > ì‹œê°ì  ë³€ê²½ì‚¬í•­ì´ ìˆë‹¤ë©´ Chromaticì—ì„œ ë¦¬ë·°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.
            `;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
