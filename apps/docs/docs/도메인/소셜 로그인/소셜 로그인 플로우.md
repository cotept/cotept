---
sidebar_position: 2
---

# 소셜 로그인 상세 플로우

## 전체 프로세스 개요

소셜 로그인은 프론트엔드에서 시작하여 OAuth 제공자, 백엔드 서버를 거쳐 최종적으로 데이터베이스에 저장되기까지 여러 단계를 거칩니다. 각 단계별로 자세히 살펴보겠습니다.

## 멘티의 소셜 로그인 플로우

1. **프론트엔드 초기 요청**
   프론트엔드에서 사용자가 "Google로 시작하기" 버튼을 클릭하면, 백엔드의 `/auth/mentee/google` 엔드포인트로 요청을 보냅니다.

2. **백엔드의 OAuth 리다이렉션**

   ```typescript
   // 백엔드는 Google OAuth URL을 생성하고 사용자를 리다이렉트합니다
   https://accounts.google.com/o/oauth2/v2/auth?
     client_id=YOUR_CLIENT_ID&
     redirect_uri=https://your-domain.com/auth/mentee/google/callback&
     response_type=code&
     scope=email profile&
     state=random-secure-string
   ```

3. **Google 인증 완료 후**
   Google에서 인증이 완료되면 우리 서비스의 콜백 URL로 인증 코드와 함께 리다이렉트됩니다.

   ```
   https://your-domain.com/auth/mentee/google/callback?code=4/P7q7W91&state=random-secure-string
   ```

4. **백엔드 처리 과정**

   ```typescript
   // 1. 인증 코드로 Google에서 액세스 토큰 획득
   const tokenResponse = await axios.post(
     "https://oauth2.googleapis.com/token",
     {
       code,
       client_id: GOOGLE_CLIENT_ID,
       client_secret: GOOGLE_CLIENT_SECRET,
       redirect_uri: CALLBACK_URL,
       grant_type: "authorization_code",
     },
   )

   // 2. 액세스 토큰으로 사용자 정보 획득
   const userInfo = await axios.get(
     "https://www.googleapis.com/oauth2/v2/userinfo",
     {
       headers: { Authorization: `Bearer ${tokenResponse.data.access_token}` },
     },
   )
   ```

5. **데이터베이스 처리**

   ```sql
   -- 1. mentees 테이블에 기본 정보 저장
   INSERT INTO mentees (email, is_email_verified, status)
   VALUES ('user@gmail.com', true, 'ACTIVE')
   RETURNING id;

   -- 2. mentee_social_accounts 테이블에 소셜 계정 정보 저장
   INSERT INTO mentee_social_accounts (mentee_id, provider, social_id, email)
   VALUES ($1, 'GOOGLE', '12345', 'user@gmail.com');
   ```

6. **프론트엔드로 응답**
   ```json
   {
     "needsAdditionalInfo": true,
     "temporaryToken": "jwt-token-for-additional-info",
     "redirectUrl": "/mentee/onboarding"
   }
   ```

## 멘토의 소셜 로그인 플로우

멘토의 경우 기본적인 플로우는 동일하나, 다음과 같은 추가 단계가 있습니다:

1. **백준 티어 검증**

   ```typescript
   const tierInfo = await axios.get(`https://solved.ac/api/v3/user/show`, {
     params: { handle: bojId },
   })

   if (!isTierEligible(tierInfo.data.tier)) {
     throw new UnauthorizedException("멘토 자격 요건을 충족하지 않습니다")
   }
   ```

2. **데이터베이스 처리**
   ```sql
   -- mentors 테이블에 Pending 상태로 저장
   INSERT INTO mentors
   (email, is_email_verified, status, approval_status, current_tier)
   VALUES
   ('mentor@gmail.com', true, 'ACTIVE', 'PENDING', 'Platinum 3')
   RETURNING id;
   ```

## 프로필 완성 플로우

소셜 로그인 후 추가 정보 입력이 필요한 경우:

1. **프론트엔드**
   임시 토큰을 사용하여 추가 정보 입력 페이지로 이동합니다.

2. **추가 정보 제출**

   ```typescript
   // 멘티의 경우
   POST /auth/mentee/complete-profile
   {
     "bojId": "user123",
     "phone": "01012345678"
   }

   // 멘토의 경우
   POST /auth/mentor/complete-profile
   {
     "bojId": "mentor123",
     "phone": "01012345678",
     "introduction": "알고리즘 전문가입니다",
     "occupation": "백엔드 개발자",
     "experience": 5
   }
   ```

3. **최종 토큰 발급**
   프로필 완성 후 실제 사용할 JWT 토큰을 발급합니다.

## 보안 고려사항

1. **상태 검증**
   모든 OAuth 요청에는 state 파라미터를 포함하여 CSRF 공격을 방지합니다.

2. **토큰 관리**
   임시 토큰은 짧은 유효기간을 가지며, 추가 정보 입력에만 사용됩니다.

## 에러 처리

각 단계별로 발생할 수 있는 주요 에러 시나리오:

1. **OAuth 인증 실패**

   - 잘못된 클라이언트 정보
   - 사용자의 권한 거부
   - 네트워크 오류

2. **추가 정보 검증 실패**
   - 중복된 백준 ID
   - 부적절한 티어 레벨
   - 전화번호 인증 실패

각 에러는 적절한 에러 메시지와 함께 프론트엔드로 전달되어 사용자에게 안내됩니다.
